@{
    ViewBag.Title = "Tablero";
}


<canvas id="c" style="border: 1px #000 solid; cursor: pointer; background-color: black; "></canvas>


<div class="btn-toolbar" role="toolbar">

    <div class="btn-group btn-group-sm">
        <button id="pick-color" type="button" class="btn btn-default"><span class="fa fa-square " title="Pick a color" ></span></button>
        <div class="colorpalette" style="display:none;"></div>
    </div>
    <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-default reset"><span class="glyphicon glyphicon-trash " data-toggle="tooltip" data-placement="bottom" title="Reset - erases everything" style="color: black;"></span></button>
        <button type="button" class="btn btn-default eraser"><span class="fa fa-eraser " data-toggle="tooltip" data-placement="bottom" title="Eraser - increases line width" style="color: black;"></span></button>
        <button type="button" class="btn btn-default export"><span class="glyphicon glyphicon-floppy-disk" data-toggle="tooltip" data-placement="bottom" title="Save drawing"></span></button>

        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-default">Background</button>
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu" role="menu">
                <li><a href="#" class="switch-back">White</a></li>
                <li><a href="#" class="switch-back">Black</a></li>

            </ul>

        </div>
    </div>
    <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-primary dropdown-toggle" title="Untick to mute the user" data-toggle="dropdown">
            Online Users <span class="badge" id="counter">0</span>
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" id="status">
        </ul>
    </div>
</div>
<br />
<div class="modal fade" id="modal_name">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">

                <h4 class="modal-title">What's your name?</h4>
            </div>
            <div class="modal-body">
                <p>I need it before we start:</p>
                <input type="text" id="name-text" class="form-control" placeholder="Enter name or nickname" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="ok-name">OK</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

@section scripts
{


    @Scripts.Render("~/bundles/Tablero")
    @Scripts.Render("~/bundles/signalr")


    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script>

        $(function() {
            var tablero = null;
            var tableroHub = $.connection.tableroHub;
            var name = $.cookie('name');
            
            var connect = function() {
                $.connection.hub.start().done(function() {
                    tablero = $('#c').Tablero({
                        remoteDraw: function(shape) {
                            tableroHub.server.draw(shape);
                        }
                    });
                }).then(function() {
                    tableroHub.server.getConnectedUsers(name);
                    $('#user_name').text('Welcome, ' + name.substring(0, 1).toUpperCase() + name.substring(1));
                }).fail(function(error) {

                    console.log(error);
                });
            };


            $('#c').width($('.container').width());
            $('#c').height($(document).height()-250);

            if (name == null || name == '') {
                $('#modal_name').modal();
            } else
                connect();

            $('#ok-name').click(function() {
                name = $('#name-text').val();

                if (name == '') {
                    $('#modal_name').modal('show');
                } else {
                    $('#modal_name').modal('hide');
                    $.cookie('name', name);

                    connect();
                }
            });


            //Hub client-side implementations of the server's functions
            tableroHub.client.reset = function(sender) {
                tablero.reset(sender);
            };

            tableroHub.client.draw = function(shape) {
                tablero.draw(shape);
            };

            tableroHub.client.changeColor = function(color) {
                tablero.changeColor(color);
            };

            tableroHub.client.listConnectedUsers = function(users) {

                var content = '';
                var count = 0;
                $.each(users, function(index, value) {
                    content += $('<li/>').text(value.user + (value.connection_id == $.connection.hub.id ? ' (You)' : '')).append('<input class="block" type="checkbox" ' + (tablero.isUserIgnored(value.user) == false ? 'checked="checked" ' : '') + (value.connection_id == $.connection.hub.id ? ' disabled="disabled" ' : '') + ' "  />').wrapInner('<span class="checkbox" />').wrapInner("<a/>")[0].outerHTML;
                    count++;
                });
                $('#counter').text(count);
                $('#status').html(content);
            };


           

            ///event handlers for the various controls in the page

         

            $('#pick-color').css({ color: 'yellow' });

            $('.colorpalette').colorPalette().on('selectColor', function(e) {
                $(this).toggle();
                tablero.changeColor(e.color);
                $('#pick-color').css({ color: e.color });
            });


            $('#pick-color').click(function() {
                $('.colorpalette').toggle();
            });

            $('span[data-toggle="tooltip"]').tooltip();

            $('.reset').click(function() {
                tableroHub.server.reset();

                tablero.reset();
            });

            $('.eraser').click(function() {
                tablero.eraser();
            });

            $('.switch-back').click(function() {
                tablero.changeBackgroundColor($(this).text());

            });

            $('.export').click(function() {
                tablero.exportImage();
            });

            $(document).on('click', 'input.block:enabled', function() {
                var user = $(this).parent().text();
                if (this.checked) {
                    tablero.unblock(user);
                } else {
                    tablero.block(user);
                }
            });

            //prevent scrolling
            document.body.addEventListener('touchmove', function(event) {
                event.preventDefault();
            }, false);

           
        });

    </script>
}
