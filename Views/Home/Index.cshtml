@{
    ViewBag.Title = "Tablero";
}


<div style="position: relative; width: 100%; height: 100%;">

    <canvas id="c" style="border: 1px #000 solid; cursor: pointer; background-color: black; width: 100%; height: 50%;"></canvas>

</div>

<div class="btn-toolbar" role="toolbar">
   
    <div class="btn-group btn-group-lg">
         <input type="text" value="white" id="fore-color" class="pick-a-color">
    </div>
    <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-default reset"><span class="glyphicon glyphicon-trash " data-toggle="tooltip" data-placement="bottom" title="Reset - erases everything" style="color: black;"></span></button>
        <button type="button" class="btn btn-default eraser"><span class="glyphicon glyphicon-minus-sign " data-toggle="tooltip" data-placement="bottom" title="Eraser - increases line width" style="color: black;"></span></button>
        <button type="button" class="btn btn-default export"><span class="glyphicon glyphicon-floppy-disk" data-toggle="tooltip" data-placement="bottom" title="Save drawing"></span></button>
        <button type="button" class="btn btn-default">Background</button>
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="#" class="switch-back">White</a></li>
            <li><a href="#" class="switch-back">Black</a></li>

        </ul>
    </div>
</div>
<br />
<div class="modal fade" id="modal_name">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">

                <h4 class="modal-title">What's your name?</h4>
            </div>
            <div class="modal-body">
                <p>I need it before we start:</p>
                <input type="text" id="name-text" class="form-control" placeholder="Enter name or nickname" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="ok-name">OK</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<div class="list-group">
    <a href="#" class="list-group-item active">Users (uncheck to ignore updates from him/her)
    </a>
    <div id="status"></div>
</div>
@section scripts
{
    @Scripts.Render("~/bundles/Tablero")
    @Scripts.Render("~/bundles/signalr")

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script>

        $(function () {
            var tablero = null;
            var tableroHub = $.connection.tableroHub;
            var name = $.cookie('name');

            var connect = function () {
                $.connection.hub.start().done(function () {
                    tablero = $('#c').Tablero({
                        remoteDraw: function (coords, width) {
                            tableroHub.server.draw(coords, width);
                        }
                    });
                }).then(function () {

                    tableroHub.server.getConnectedUsers(name);
                    $('#user_name').text('Welcome, ' + name.substring(0, 1).toUpperCase() + name.substring(1));
                }).fail(function (error) {

                    console.log(error);
                });
            };

            if (name == null || name == '') {
                $('#modal_name').modal();
            } else
                connect();

            $('#ok-name').click(function () {
                name = $('#name-text').val();

                if (name == '') {
                    $('#modal_name').modal('show');
                } else {
                    $('#modal_name').modal('hide');
                    $.cookie('name', name);

                    connect();
                }
            });

            $(".pick-a-color").pickAColor({ showHexInput: false });

            $('#fore-color').on('change', function () {
                tablero.changeColor($(this).val());
                tableroHub.server.changeColor($(this).val());
            });


            $('span[data-toggle="tooltip"]').tooltip();


            tableroHub.client.reset = function (sender) {
                tablero.reset(sender);
            };

            tableroHub.client.draw = function (coords, lineWidth, from) {

                tablero.draw(coords, lineWidth, from);
            };

            tableroHub.client.changeColor = function (color) {
                tablero.changeColor(color);
            };

            tableroHub.client.listConnectedUsers = function (users) {
                var content = '';
                $.each(users, function (index, value) {
                    content += $('<a/>').text(value).addClass('list-group-item').append('<input type="checkbox" ' + (tablero.isUserIgnored(value) == false ? 'checked="checked"' : '') + '" class="block" />').wrapInner('<label>').wrapInner('<div class="checkbox"/>')[0].outerHTML;

                });
                $('#status').html('<ul class="list-group">' + content + '</ul>');
            };

            $('.reset').click(function () {
                tableroHub.server.reset();

                tablero.reset();
            });

            $('.eraser').click(function () {
                tablero.eraser();
            });

            $('.switch-back').click(function () {
                tablero.changeBackgroundColor($(this).text());

            });

            $('.export').click(function () {
                tablero.exportImage();
            });

            //prevent scrolling
            document.body.addEventListener('touchmove', function (event) {
                event.preventDefault();
            }, false);

            $(document).on('click', '.block', function () {
                var user = $(this).parent().text();
                if (this.checked) {
                    tablero.unblock(user);
                } else {
                    tablero.block(user);
                }
            });
        });
    </script>
}
