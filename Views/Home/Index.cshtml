@{
    ViewBag.Title = "Tablero";
}

<canvas id="c" width="670" height="400" style="border: 1px #000 solid; cursor: pointer; background-color: black;"></canvas>
<div class="btn-toolbar" role="toolbar">
    <div class="btn-group btn-group-lg">
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop" data-toggle="tooltip" data-placement="bottom" title="Green" style="color: green;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop" data-toggle="tooltip" data-placement="bottom" title="Red" style="color: red;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop " data-toggle="tooltip" data-placement="bottom" title="Yellow" style="color: yellow;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop " data-toggle="tooltip" data-placement="bottom" title="Blue" style="color: blue;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop " data-toggle="tooltip" data-placement="bottom" title="Magenta" style="color: magenta;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-unchecked " data-toggle="tooltip" data-placement="bottom" title="White" style="color: papayawhip;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop " data-toggle="tooltip" data-placement="bottom" title="Black" style="color: black;"></span></button>
        <button type="button" class="btn btn-default color"><span class="glyphicon glyphicon-stop " data-toggle="tooltip" data-placement="bottom" title="Brown" style="color: brown;"></span></button>
    </div>
    <div class="btn-group btn-group-lg">
        <button type="button" class="btn btn-default reset"><span class="glyphicon glyphicon-trash " data-toggle="tooltip" data-placement="bottom" title="Reset - erases everything" style="color: black;"></span></button>
        <button type="button" class="btn btn-default eraser"><span class="glyphicon glyphicon-minus-sign " data-toggle="tooltip" data-placement="bottom" title="Eraser - increases line width" style="color: black;"></span></button>
        <button type="button" class="btn btn-default export"><span class="glyphicon glyphicon-floppy-disk" data-toggle="tooltip" data-placement="bottom" title="Save drawing"></span></button>
        <button type="button" class="btn btn-default">Background</button>
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="#" class="switch-back">White</a></li>
            <li><a href="#" class="switch-back">Black</a></li>

        </ul>
    </div>
</div>
<br/>
<div class="modal fade" id="modal_name">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">

                <h4 class="modal-title">What's your name?</h4>
            </div>
            <div class="modal-body">
                <p>Please tell me your name before we start:</p>
                <input type="text" id="name-text" class="form-control" placeholder="Enter name or nickname" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="ok-name">OK</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<div class="list-group">
    <a href="#" class="list-group-item active">Users (uncheck to ignore updates from him/her)
    </a>
    <div id="status"></div>
</div>
@section scripts
{
    @Scripts.Render("~/bundles/Tablero")
    @Scripts.Render("~/bundles/signalr")

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script>

        $(function() {
            var tablero = null;
            var tableroHub = $.connection.tableroHub;
            var name = $.cookie('name');

            var connect = function() {
                $.connection.hub.start().done(function() {
                    tablero = $('#c').Tablero({
                        remoteDraw: function(coords, width) {
                            tableroHub.server.draw(coords, width);
                        }
                    });
                }).then(function() {

                    tableroHub.server.getConnectedUsers(name);
                    $('#user_name').text('Bienvenido, ' + name.substring(0, 1).toUpperCase() + name.substring(1));
                }).fail(function(error) {

                    console.log(error);
                });
            };

            if (name == null || name == '') {
                $('#modal_name').modal();
            } else
                connect();

            $('#ok-name').click(function() {
                name = $('#name-text').val();

                if (name == '') {
                    $('#modal_name').modal('show');
                } else {
                    $('#modal_name').modal('hide');
                    $.cookie('name', name);

                    connect();
                }
            });

            $('span[data-toggle="tooltip"]').tooltip();


            tableroHub.client.reset = function(sender) {
                tablero.reset(sender);
            };

            tableroHub.client.draw = function(coords, lineWidth, from) {
                
                tablero.draw(coords, lineWidth,from);
            };

            tableroHub.client.changeColor = function(color) {
                tablero.changeColor(color);
            };

            tableroHub.client.listConnectedUsers = function(users) {
                var content = '';
                $.each(users, function(index, value) {
                    content += $('<a/>').text(value).addClass('list-group-item').append('<input type="checkbox" '+(tablero.isUserIgnored(value)==false?'checked="checked"':'')+'" class="block" />').wrapInner('<label>').wrapInner('<div class="checkbox"/>')[0].outerHTML;

                });
                $('#status').html('<ul class="list-group">' + content + '</ul>');
            };

            $('.reset').click(function() {
                tableroHub.server.reset();

                tablero.reset();
            });

            $('.eraser').click(function() {
                tablero.eraser();
            });

            $('.switch-back').click(function() {
                tablero.changeBackgroundColor($(this).text());

            });

            $('.export').click(function() {
                tablero.exportImage();
            });

            //prevent scrolling
            document.body.addEventListener('touchmove', function(event) {
                event.preventDefault();
            }, false);

            $('.color').click(function() {
                var color = $(this).find('span').css('color');
                tablero.changeColor(color);
                tableroHub.server.changeColor(color);
            });

            $(document).on('click','.block',function () {
                var user = $(this).parent().text();
                if (this.checked) {
                    tablero.unblock(user);
                } else {
                    tablero.block(user);
                }
            });


        });
    </script>
}
